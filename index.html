<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Work Request Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Segoe UI, Arial,sans-serif; margin:0; background:#f6fafd; }
    header { background:#013963; color:#fff; padding:1em 2em; }
    header h1 { margin:0; }
    .role-switch { float:right; margin-top:-2.7em; }
    .container { max-width:1080px; margin:2em auto; background:#fff; border-radius:8px; box-shadow:0 0 16px #ebebeb; padding:2em; }
    h2 { color:#0069d9; margin-top:0.1em; }
    form { margin-bottom:2em; }
    label { display:block; font-weight:bold; margin:1em 0 0.5em; }
    input[type="text"], textarea, select { width:100%; padding:0.7em; margin-bottom:0.8em; border-radius:5px; border:1px solid #bbb; }
    .split-row { display:grid; grid-template-columns:1fr 1fr; gap:1em;}
    button, .fake-link { background:#0069d9; color:#fff; border:none; border-radius:5px; padding:0.7em 1.5em; font-size:1em; cursor:pointer; }
    .actions button, .actions .fake-link {padding:0.4em 1em; font-size:0.95em;}
    button:hover, .fake-link:hover { background:#0053a3; }
    .fake-link {background:none;color:#0069d9;text-decoration:underline;cursor:pointer;border:none;}
    table { width:100%; border-collapse:collapse; margin-top:1em; }
    th, td { padding:0.65em; border-bottom:1px solid #e7e7e7; vertical-align:top;}
    th { background:#013963; color:#fff; position:sticky; top:0; z-index:1; }
    tr:hover:not(.detail-row) {background:#f1f7ff;}
    .badge { padding:2px 8px; border-radius:12px; font-size:0.9em; color:#fff;}
    .pending { background:#ffaa55; }
    .inprogress { background:#56c6ff;}
    .completed { background:#57ce90; }
    .onhold {background:#ccc016;}
    .detail-row { background:#f1f5fc !important; }
    .detail-cell { padding:1.2em 2em; font-size:1.08em; color:#222; }
    .sr-label { color:#245; font-weight: bold;}
    .commentbox {margin-top:1em; background:#fdfad7;padding:0.75em 1em;border-radius:6px;}
    .commentlog {font-size:0.97em; margin-top:0.6em;}
    .internal {background:#e3f7e3;padding:4px 7px;border-radius:4px;font-size:0.98em;}
    .extern {background:#eaf6ff;padding:4px 7px;border-radius:4px;font-size:0.98em;}
    .attachment {margin-left:0.8em;font-size:0.9em;}
    .filter-bar {margin-bottom:1em; display:flex; flex-wrap:wrap; gap:0.7em;}
    .filter-bar > * {margin:0;}
    .dash {font-size:1em; margin:1em 0 2em; display:flex; gap:2.4em;}
    .dashbox {background:#f5f6fb;padding:1em 1.5em;border-radius:5px;box-shadow:0 2px 8px #efefef;font-size:1.1em;}
    .assigned {font-size:0.93em;color:#014b70;}
    .csv-export {margin-left:1.5em;font-size:0.97em;}
    @media (max-width: 700px) {
      .container {padding:0.5em;}
      th,td {font-size:0.95em;white-space:normal;}
      .split-row {grid-template-columns:1fr;}
    }
    footer { text-align:center; color:#999; padding:1em; margin-top:2em; }

    /* Login Screen Styles */
    .login-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .login-form {
      background: white;
      padding: 2em;
      border-radius: 8px;
      box-shadow: 0 0 20px rgba(0,0,0,0.2);
      width: 400px;
    }
    .login-form input {
      width: 100%;
      padding: 0.8em;
      margin: 0.5em 0;
    }
    .login-form button {
      width: 100%;
      padding: 0.8em;
      background: #013963;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .login-form button:hover {
      background: #0053a3;
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div class="login-screen" id="loginScreen">
    <div class="login-form">
      <h2>Login</h2>
      <form id="loginForm">
        <input type="text" id="username" placeholder="Username" required>
        <input type="password" id="password" placeholder="Password" required>
        <button type="submit">Login</button>
      </form>
    </div>
  </div>

  <header>
    <h1>Work Request Portal</h1>
    <div class="role-switch">
      <label for="roleSelect" style="font-weight:normal;">View as: </label>
      <select id="roleSelect">
        <option value="staff">Staff</option>
        <option value="sys">Systems Team</option>
        <option value="admin">Admin</option>
      </select>
    </div>
  </header>
  <div class="container" id="container">
    <div class="dash" id="dashboard"></div>

    <div id="staffFormSection">
      <h2>Submit New Request</h2>
      <form id="requestForm">
        <div class="split-row">
          <div>
            <label for="reqRequester">Your Name</label>
            <input type="text" id="reqRequester" required>
          </div>
          <div>
            <label for="reqCategory">Category</label>
            <select id="reqCategory">
              <option>General</option>
              <option>Payroll</option>
              <option>Benefits</option>
              <option>Recruiting</option>
              <option>Onboarding</option>
              <option>Training/Learning</option>
              <option>System Access</option>
              <option>Reporting</option>
              <option>Other</option>
            </select>
          </div>
        </div>
        <label for="reqTitle">Title</label>
        <input type="text" id="reqTitle" required>
        <label for="reqDesc">Description</label>
        <textarea id="reqDesc" rows="2" required></textarea>
        <div class="split-row">
          <div>
            <label for="reqPriority">Priority</label>
            <select id="reqPriority">
              <option>Medium</option>
              <option>Low</option>
              <option>High</option>
              <option>Critical</option>
            </select>
          </div>
          <div>
            <label for="reqAttachment">Attachment (link or filename)</label>
            <input type="text" id="reqAttachment" placeholder="Paste URL or filename">
          </div>
        </div>
        <button type="submit">Submit Request</button>
      </form>
    </div>

    <div class="filter-bar" id="filterBar"></div>

    <h2>Work Requests</h2>
    <table id="requestsTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Title / Category</th>
          <th>Status</th>
          <th>Priority</th>
          <th>Requester</th>
          <th>Created</th>
          <th>Assigned</th>
        </tr>
      </thead>
      <tbody>
        <!-- Requests go here -->
      </tbody>
    </table>
    <div class="csv-export">
      <button onclick="exportCSV()">Export CSV</button>
    </div>
  </div>
  <footer>
    &copy; 2025 Work Request Portal
  </footer>

  <script>
    // Define allowed users with their roles and passwords
    const allowedUsers = {
      'Jason': { password: 'Test', role: 'staff' },
      'sysadmin123': { password: 'sysadmin123', role: 'sys' },
      'admin123': { password: 'admin123', role: 'admin' }
    };

    let loggedInUser = null;
    let requests = JSON.parse(localStorage.getItem('requests_2') || '[]');
    let nextId = requests.length ? Math.max(...requests.map(r => r.id)) + 1 : 1;
    let openedDetailId = null;
    let userRole = 'guest'; // Default role with no access
    let userName = "";
    let filterStatus = "";
    let filterMyTickets = false;
    let filterCategory = "";

    const ROLE_OPTIONS = {
      "staff": "Staff",
      "sys": "Systems Team",
      "admin": "Admin"
    };

    function $(id) { return document.getElementById(id); }

    // Check if user is logged in
    function checkLogin() {
      if (!loggedInUser) {
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('container').style.display = 'none';
      } else {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('container').style.display = 'block';
      }
    }

    // Handle login form submission
    document.getElementById('loginForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      
      if (allowedUsers[username] && allowedUsers[username].password === password) {
        loggedInUser = {
          username: username,
          role: allowedUsers[username].role
        };
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('container').style.display = 'block';
        applyRole(loggedInUser.role);
      } else {
        alert('Invalid username or password');
      }
    });

    // Logout functionality
    function logout() {
      loggedInUser = null;
      checkLogin();
      applyRole('guest');
    }

    // Add logout button
    const logoutButton = document.createElement('button');
    logoutButton.textContent = 'Logout';
    logoutButton.style.position = 'absolute';
    logoutButton.style.top = '10px';
    logoutButton.style.right = '10px';
    logoutButton.style.backgroundColor = '#ff0000';
    logoutButton.style.color = 'white';
    logoutButton.style.padding = '0.5em 1em';
    logoutButton.style.borderRadius = '5px';
    logoutButton.style.cursor = 'pointer';
    logoutButton.onclick = logout;
    document.body.appendChild(logoutButton);

    // Apply role-based access
    function applyRole(role) {
      if (!loggedInUser) return;
      
      userRole = role;
      localStorage.setItem('portal_role', role);
      
      if (role === 'staff') {
        document.getElementById('staffFormSection').style.display = '';
      } else {
        document.getElementById('staffFormSection').style.display = 'none';
      }
      
      renderRequests();
    }

    // Initial check
    checkLogin();

    // Dashboard summary counts
    function renderDash() {
      let total = requests.length;
      let pending = requests.filter(r => r.status === "Pending").length;
      let inprogress = requests.filter(r => r.status === "In Progress").length;
      let completed = requests.filter(r => r.status === "Completed").length;
      let critical = requests.filter(r => r.priority === "Critical" && r.status !== "Completed").length;
      $("dashboard").innerHTML = `
        <div class="dashbox">Total: <b>${total}</b></div>
        <div class="dashbox">Pending: <b>${pending}</b></div>
        <div class="dashbox">In Progress: <b>${inprogress}</b></div>
        <div class="dashbox">Completed: <b>${completed}</b></div>
        <div class="dashbox" style="color:#d12a2a;">Critical: <b>${critical}</b></div>
      `;
    }

    // Filtering controls!
    function renderFilters() {
      let catSet = new Set();
      requests.forEach(r => catSet.add(r.category));
      let catOpt = [...catSet].sort().filter(Boolean).map(c =>
        `<option${c === filterCategory ? " selected" : ""}>${c}</option>`
      ).join("");
      $("filterBar").innerHTML = `
        <label>Status:
          <select onchange="setFilterStatus(this.value)">
            <option value="">All</option>
            <option${filterStatus === "Pending" ? " selected" : ""}>Pending</option>
            <option${filterStatus === "In Progress" ? " selected" : ""}>In Progress</option>
            <option${filterStatus === "Completed" ? " selected" : ""}>Completed</option>
            <option${filterStatus === "On Hold" ? " selected" : ""}>On Hold</option>
          </select>
        </label>
        <label>Category:
          <select onchange="setFilterCategory(this.value)">
            <option value="">All</option>
            ${catOpt}
          </select>
        </label>
        <label>
          <input type="checkbox" ${filterMyTickets ? "checked" : ""} onchange="toggleMyTickets()"> My Tickets
        </label>
        <label>
          <input type="text" id="searchBox" placeholder="Search title/desc" oninput="renderRequests()">
        </label>
      `;
    }

    function setFilterStatus(val) { filterStatus = val; renderRequests(); }
    function setFilterCategory(val) { filterCategory = val; renderRequests(); }
    function toggleMyTickets() { filterMyTickets = !filterMyTickets; renderRequests(); }

    function getStatusBadge(status) {
      let s = status || "";
      let c = { Pending: "pending", "In Progress": "inprogress", "Completed": "completed", "On Hold": "onhold" }[s] || "";
      return `<span class="badge ${c}">${s}</span>`;
    }

    function getAttachment(a) {
      if (!a) return "";
      if (a.match(/^https?:\/\/|^ftp:\/\//i)) {
        return `<a href="${a}" class="attachment" target="_blank">Attachment</a>`;
      }
      return `<span class="attachment">${a}</span>`;
    }

    function getAssignee(req) {
      if (req.assignedTo) return `<span class="assigned">ðŸ‘¤ ${req.assignedTo}</span>`;
      else if (userRole === "sys" || userRole === "admin")
        return `<button onclick="assignTicket(${req.id}); event.stopPropagation();">Pick up</button>`;
      return "";
    }

    function formatDT(dt) {
      if (!dt) return "";
      const d = new Date(dt);
      return d.toLocaleString();
    }

    function matchesSearch(req) {
      let q = $("searchBox")?.value.trim().toLowerCase();
      if (!q) return true;
      return (req.title + " " + req.description + " " + req.requester).toLowerCase().indexOf(q) !== -1;
    }

    function renderRequests() {
      renderDash();
      renderFilters();
      const tbody = $("requestsTable").querySelector("tbody");
      tbody.innerHTML = '';
      let show = requests.filter(r =>
        (!filterStatus || r.status === filterStatus) &&
        (!filterCategory || r.category === filterCategory) &&
        (!filterMyTickets || r.requester === userName || r.assignedTo === userName) &&
        matchesSearch(r)
      );
      if (show.length === 0) {
        tbody.innerHTML = `<tr><td style="text-align:center;color:#888;" colspan="7">No tickets found.</td></tr>`;
      }
      show.sort((a, b) => b.id - a.id).forEach(req => {
        tbody.innerHTML += `
          <tr style="cursor:pointer;" onclick="toggleDetail(${req.id})">
            <td>${req.id}</td>
            <td><b>${req.title}</b><br><span style="font-size:0.94em;color:#555">${req.category || ""}</span></td>
            <td>${getStatusBadge(req.status)}</td>
            <td>${req.priority}</td>
            <td>${req.requester}</td>
            <td>${formatDT(req.createdAt)}</td>
            <td>${getAssignee(req)}</td>
          </tr>
          ${openedDetailId === req.id ? renderDetailRow(req) : ''}`;
      });
    }

    function renderDetailRow(req) {
      return `
        <tr class="detail-row">
          <td class="detail-cell" colspan="7">
            <div><span class="sr-label">Description:</span><br>${req.description || ""}</div>
            <div><span class="sr-label">Attachment:</span> ${getAttachment(req.attachment) || 'None'}</div>
            <div><span class="sr-label">Priority:</span> ${req.priority}  <span class="sr-label" style="margin-left:1.5em;">Status:</span> ${getStatusBadge(req.status)}</div>
            <div><span class="sr-label">Category:</span> ${req.category || ""} <span class="sr-label" style="margin-left:2em;">Requester:</span> ${req.requester || ""}</div>
            <div><span class="sr-label">Created:</span> ${formatDT(req.createdAt)}</div>
            <div><span class="sr-label">Assigned To:</span> ${req.assignedTo || "Unassigned"}</div>
            
            <div style="margin:1.2em 0 0.5em;">
              ${getDetailActions(req)}
            </div>
            ${renderEditForm(req)}
            <div class="commentbox">
              <div><b>Internal Comments</b> <span style="color:#888;font-size:0.96em">(Only visible to Systems Team/Admin)</span></div>
              ${renderCommentForm(req)}
              ${renderCommentLog(req)}
            </div>
          </td>
        </tr>
      `;
    }

    function getDetailActions(req) {
      if (userRole === "sys" || userRole === "admin") {
        let actions = '<div class="actions">';
        if (req.status !== "Completed") {
          actions += `<button onclick="updateStatus(${req.id}, 'Completed')">Mark as Completed</button>`;
        }
        if (req.status !== "In Progress") {
          actions += `<button onclick="updateStatus(${req.id}, 'In Progress')">Mark as In Progress</button>`;
        }
        if (req.status !== "On Hold") {
          actions += `<button onclick="updateStatus(${req.id}, 'On Hold')">Mark as On Hold</button>`;
        }
        if (req.status !== "Pending") {
          actions += `<button onclick="updateStatus(${req.id}, 'Pending')">Mark as Pending</button>`;
        }
        actions += '</div>';
        return actions;
      }
      return '';
    }

    function updateStatus(id, status) {
      const req = requests.find(r => r.id === id);
      if (req) {
        req.status = status;
        req.updatedAt = new Date().toISOString();
        saveRequests();
        renderRequests();
      }
    }

    function renderEditForm(req) {
      if (userRole === "staff" && req.requester !== userName) return '';
      let showEdit = window._editingId === req.id;
      if (!showEdit) return `<button class="fake-link" onclick="startEdit(${req.id}); event.stopPropagation();">Edit Request</button>`;
      return `
        <form onsubmit="saveEdit(${req.id}); event.preventDefault();">
          <div class="split-row">
            <div>
              <label for="editTitle">Title</label>
              <input type="text" id="editTitle" value="${req.title}" required>
            </div>
            <div>
              <label for="editCategory">Category</label>
              <select id="editCategory">
                <option>General</option>
                <option>Payroll</option>
                <option>Benefits</option>
                <option>Recruiting</option>
                <option>Onboarding</option>
                <option>Training/Learning</option>
                <option>System Access</option>
                <option>Reporting</option>
                <option>Other</option>
              </select>
            </div>
          </div>
          <label for="editDesc">Description</label>
          <textarea id="editDesc" rows="2">${req.description}</textarea>
          <div class="split-row">
            <div>
              <label for="editPriority">Priority</label>
              <select id="editPriority">
                <option>Medium</option>
                <option>Low</option>
                <option>High</option>
                <option>Critical</option>
              </select>
            </div>
            <div>
              <label for="editAttachment">Attachment (link or filename)</label>
              <input type="text" id="editAttachment" value="${req.attachment || ''}">
            </div>
          </div>
          <div style="margin-top:1em;">
            <button type="submit">Save Changes</button>
            <button class="fake-link" onclick="cancelEdit(${req.id})">Cancel</button>
          </div>
        </form>
      `;
    }

    function startEdit(id) {
      window._editingId = id;
      renderRequests();
    }

    function cancelEdit(id) {
      window._editingId = null;
      renderRequests();
    }

    function saveEdit(id) {
      const req = requests.find(r => r.id === id);
      if (req) {
        req.title = document.getElementById('editTitle').value;
        req.description = document.getElementById('editDesc').value;
        req.category = document.getElementById('editCategory').value;
        req.priority = document.getElementById('editPriority').value;
        req.attachment = document.getElementById('editAttachment').value;
        window._editingId = null;
        saveRequests();
        renderRequests();
      }
    }

    function saveRequests() {
      localStorage.setItem('requests_2', JSON.stringify(requests));
    }

    function exportCSV() {
      const csv
